---
title: "Dispersal Kernel clustering analysis for SharkRayMPA project"
author: "Vinay Udyawer"
date: "04/05/2018"
output: html_document
---

Script to calculate dispersal kernel metrics before conducting clustering analysis
Since we have multiple sources of data we will try and standardise the dispersal kernels we will first use maximum dispersal to construct a comparison between Fisheries mark recapture, Acoustic Telemetry and Satellite telemetry

```{r, eval=TRUE}
suppressPackageStartupMessages(library(tidyverse))

## Input data
fish <- as_tibble(read.csv("Data/Fisheries data/2018-03-16_Fisheries.csv"))
imos <- as_tibble(read.csv("Data/Acoustic data/IMOS/2018-03-16_IMOS_PassiveTelemetry.csv"))
# otn <- readRDS("Data/Acoustic data/OTN/otn_aat_detections.rds")
sat <- as_tibble(read.csv("Data/Satellite data/Dispersal Summaries/DispersalSummary_SatTags.csv"))
```

The displot function in the R folder produces a dispersal kernel plot with associated metrics for each curve.

```{r, eval=TRUE}
source("R/displot.R")
```

## Initial comparisons between fisheries, acoustic and satellite data

Because of the difference in resolution, we will calculate dispersal kernels (gamma distribution) and associated parameters using Maximum dispersal distances. This is defined in each dataset by:

- Fisheries data: dispersal distance between mark and final recapture
```{r, eval=T}
## fisheries data summary
fDisp<-data.frame(matrix(ncol=13, nrow=0, dimnames=list(c(), c("type","n","common_name","fit","mean","sd","shape","scale","quant.0.","quant.25.","quant.50.","quant.75.","quant.90."))))
for(i in 1:length(levels(as.factor(fish$common_name)))){
  disp<-displot(fish, cn=levels(as.factor(fish$common_name))[i], var="dis", dist="gamma")
  dd<-data.frame(type="mrecap",
                 n=n_distinct(fish[fish$common_name%in%levels(as.factor(fish$common_name))[i],"TagID"]),
                 disp)
  if(i %in% 1) {fDisp<-dd} else {fDisp<-rbind(fDisp, dd)}
}

fishdisp<-as_tibble(fDisp)
```

- Acoustic data: Maximal step dispersal distance
```{r, eval=T}
## IMOS data summary
atf<-as_tibble(imos) %>% dplyr::select(-common_name) %>% rename(common_name = scientific_name)
atf<-filter(atf, !is.na(dis_max))

aDisp<-data.frame(matrix(ncol=13, nrow=0, dimnames=list(c(), c("type","n","common_name","fit","mean","sd","shape","scale","quant.0.","quant.25.","quant.50.","quant.75.","quant.90."))))
for(i in 1:length(levels(as.factor(atf$common_name)))){
  disp<-displot(atf, cn=levels(as.factor(atf$common_name))[i], var="dis_max", dist="gamma")
  dd<-data.frame(type="imos",
                 n=n_distinct(atf[atf$common_name%in%levels(as.factor(atf$common_name))[i],"tag_id"]),
                 disp)
  if(i %in% 1) {aDisp<-dd} else {aDisp<-rbind(aDisp, dd)}
}

imosdisp<-as_tibble(aDisp)
```

```{r, eval=T}
## OTN data summary
otn<-as_tibble(imos) %>% dplyr::select(-common_name) %>% rename(common_name = scientific_name)
atf<-filter(atf, !is.na(dis_max))

aDisp<-data.frame(matrix(ncol=13, nrow=0, dimnames=list(c(), c("type","n","common_name","fit","mean","sd","shape","scale","quant.0.","quant.25.","quant.50.","quant.75.","quant.90."))))
for(i in 1:length(levels(as.factor(atf$common_name)))){
  disp<-displot(atf, cn=levels(as.factor(atf$common_name))[i], var="dis_max", dist="gamma")
  dd<-data.frame(type="imos",
                 n=n_distinct(atf[atf$common_name%in%levels(as.factor(atf$common_name))[i],"tag_id"]),
                 disp)
  if(i %in% 1) {aDisp<-dd} else {aDisp<-rbind(aDisp, dd)}
}

imosdisp<-as_tibble(aDisp)
```


- Satellite data: Maximal step dispersal distance
```{r, eval=T}
## Sattelite ATN data summary
satt<-as_tibble(sat) %>% 
  filter(!is.na(Consecutive.Dispersal)) %>%
  group_by(Tag.ID) %>% 
  summarize(common_name = first(Common.Name),
            dis_mean = mean(Consecutive.Dispersal, na.rm=TRUE),
            dis_max = max(Consecutive.Dispersal, na.rm=TRUE))

sDisp<-data.frame(matrix(ncol=13, nrow=0, dimnames=list(c(), c("type","n","common_name","fit","mean","sd","shape","scale","quant.0.","quant.25.","quant.50.","quant.75.","quant.90."))))
for(i in 1:length(levels(as.factor(satt$common_name)))){
  disp<-displot(satt, cn=levels(as.factor(satt$common_name))[i], var="dis_max", dist="gamma")
  dd<-data.frame(type="sat",
                 n=n_distinct(satt[satt$common_name%in%levels(as.factor(satt$common_name))[i],"Tag.ID"]),
                 disp)
  if(i %in% 1) {sDisp<-dd} else {sDisp<-rbind(sDisp, dd)}
}

satdisp<-as_tibble(sDisp)
```











